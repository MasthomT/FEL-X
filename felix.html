<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>F√©lix et moi - FEL-X</title>
		<link rel="stylesheet" href="style.css" />
		<style>
			.section-title { color: var(--accent); font-size: 1.1rem; margin: 2rem 0 1rem 0; text-transform: uppercase; font-weight: 600; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
			.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
			.form-group label { display: block; margin-bottom: 0.5rem; color: var(--text-dim); font-size: 0.9rem; }
			input, select, textarea {
			width: 100%; padding: 12px; background: var(--bg); border: 1px solid var(--border);
			color: white; border-radius: 6px; font-size: 1rem; font-family: inherit; transition: 0.2s;
			}
			input:focus, textarea:focus { border-color: var(--accent); outline: none; background: #202024; }
			.form-full { grid-column: 1 / -1; }
			.btn-save {
			background: var(--accent); color: #18181b; border: none; padding: 14px 24px;
			font-weight: 700; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 2rem; font-size: 1.1rem;
			transition: 0.2s;
			}
			.btn-save:hover { background: white; transform: translateY(-2px); }
			.status-msg { margin-top: 1rem; padding: 1rem; border-radius: 6px; display: none; text-align: center; }
			@media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } }
		</style>
	</head>
	<body>
		<nav class="sidebar">
			<a href="profile.html" class="logo">
				<img src="logo-felix.png" alt="Logo" />
				<span>FEL-X</span>
			</a>
			<a href="profile.html" class="nav-link">Profil</a>
			<a href="infos.html" class="nav-link">Infos</a>
			<a href="leaderboard.html" class="nav-link">Classement</a>
			<a href="stats.html" class="nav-link">Stats</a>
			<a href="felix.html" class="nav-link active">F√©lix et moi</a>
			<a href="#" id="logout-btn" class="nav-link logout">D√©connexion</a>
		</nav>

		<main>
			<div style="max-width: 800px; margin: 0 auto;">
				<h1>üß† F√©lix et moi</h1>
				<p style="color: var(--text-dim); margin-bottom: 2rem;">Remplis cette fiche pour que F√©lix te connaisse mieux ! (Optionnel)</p>

				<div id="loading" style="text-align:center; padding:2rem;">Chargement de tes infos...</div>

				<form id="felixForm" style="display:none;">
					<div class="section-title">1. Identit√©</div>
					<div class="card">
						<div class="form-grid">
							<div class="form-group">
								<label>Surnom</label>
								<input type="text" id="nickname" placeholder="Comment doit-il t'appeler ?">
                        </div>
							<div class="form-group">
								<label>Anniversaire üéÇ</label>
								<input type="date" id="birthday">
                        </div>
							<div class="form-group">
								<label>Pronoms</label>
								<select id="pronouns">
									<option value="">Peu importe</option>
									<option value="il">Il / Lui</option>
									<option value="elle">Elle</option>
									<option value="iel">Iel</option>
								</select>
							</div>
							<div class="form-group">
								<label>Ta Vibe</label>
								<input type="text" id="vibe" placeholder="Ex: Chill, Troll...">
                        </div>
						</div>
					</div>

					<div class="section-title">2. Gaming</div>
					<div class="card">
						<div class="form-grid">
							<div class="form-group">
								<label>Jeu Favori ‚ù§Ô∏è</label>
								<input type="text" id="favorite_game" placeholder="Ex: Minecraft, Elden Ring, Valorant...">
                        </div>
							<div class="form-group">
								<label>Genre D√©test√© ‚ùå</label>
								<input type="text" id="hated_genre" placeholder="Ex: Horreur, Sport, FPS...">
                        </div>
							<div class="form-group form-full">
								<label>Passion hors jeux ?</label>
								<input type="text" id="hobby" placeholder="Ex: Musique, Dessin, Cuisine, Astronomie...">
                        </div>
						</div>
					</div>

					<div class="section-title">3. Go√ªts</div>
					<div class="card">
						<div class="form-grid">
							<div class="form-group">
								<label>Plat / Snack üçï</label>
								<input type="text" id="favorite_food" placeholder="Ex: Pizza, Sushi, Kinder Bueno...">
                        </div>
							<div class="form-group">
								<label>Boisson ü•§</label>
								<input type="text" id="favorite_drink" placeholder="Ex: Caf√©, Th√© glac√©, Dr Pepper...">
                        </div>
						</div>
					</div>

					<div class="section-title">4. Zone Libre</div>
					<div class="card">
						<div class="form-group">
							<label>Raconte ce que tu veux √† F√©lix (Bio, Anecdote...)</label>
							<textarea id="free_message" rows="5" placeholder="Ex: J'habite au Qu√©bec, j'ai un chat qui s'appelle Pompom et je d√©teste le r√©veil le matin..."></textarea>
						</div>
					</div>

					<button type="submit" id="saveBtn" class="btn-save">Sauvegarder</button>
				</form>
			</div>
		</main>

		<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
		<script src="config.js"></script>
		<script src="app.js"></script>

		<script>
			const fields = [
			'nickname', 'birthday', 'pronouns', 'vibe',
			'favorite_game', 'hated_genre', 'hobby',
			'favorite_food', 'favorite_drink', 'free_message'
			];

			async function getUserId(token) {
			try {
			const r = await fetch('https://api.twitch.tv/helix/users', {
			headers: { 'Authorization': `Bearer ${token}`, 'Client-Id': CONFIG.CLIENT_ID }
			});
			const d = await r.json();
			return d.data && d.data.length > 0 ? d.data[0].id : null;
			} catch (e) { return null; }
			}

			document.addEventListener('DOMContentLoaded', async () => {
			const database = firebase.database();
			const token = checkAuth();
			if(!token) return;

			const userId = await getUserId(token);
			const loadingEl = document.getElementById('loading');
			const formEl = document.getElementById('felixForm');

			if (userId) {
			// 1. CHARGEMENT DEPUIS FIREBASE
			database.ref('viewer_data/ai_context/' + userId).once('value').then((snapshot) => {
			const data = snapshot.val();
			if (data) {
			fields.forEach(f => {
			const input = document.getElementById(f);
			if (input && data[f]) input.value = data[f];
			});
			}
			}).finally(() => {
			loadingEl.style.display = 'none';
			formEl.style.display = 'block';
			});

			// 2. SAUVEGARDE
			formEl.addEventListener('submit', async (e) => {
			e.preventDefault();
			const btn = document.getElementById('saveBtn');
			btn.textContent = "Mise √† jour...";
			btn.disabled = true;

			const payload = { twitch_id: userId };
			fields.forEach(f => {
			const el = document.getElementById(f);
			if (el) payload[f] = el.value;
			});

			try {
			// √âTAPE A : FIREBASE (Cloud)
			await database.ref('viewer_data/ai_context/' + userId).update({
			...payload,
			last_updated: new Date().toISOString()
			});

			// √âTAPE B : BOT (Raspberry via Ngrok)
			try {
			await fetch(`${CONFIG.SERVER_URL}/api/update_context`, {
			method: 'POST',
			headers: {
			'Content-Type': 'application/json',
			'ngrok-skip-browser-warning': 'true'
			},
			body: JSON.stringify(payload)
			});
			alert("‚ú® Succ√®s ! Ton profil est √† jour.");
			} catch (err) {
			alert("‚úÖ Profil sauv√© sur le cloud ! (F√©lix synchronisera au prochain live)");
			}
			} catch (err) {
			alert("‚ùå Erreur de connexion.");
			} finally {
			btn.textContent = "Sauvegarder";
			btn.disabled = false;
			}
			});
			}
			});
		</script>
	</body>
</html>