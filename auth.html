<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Authentification...</title>
    <style>
        body { 
            display: grid; 
            place-items: center; 
            min-height: 100vh; 
            background: #18181b; 
            color: white; 
            font-family: sans-serif; 
            margin: 0;
        }
    </style>
</head>
<body>
    <p>Authentification en cours, veuillez patienter...</p>

<script>
    (async function handleAuth() {
        try {
            // 1. Récupérer le "code" que Twitch envoie dans l'URL
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get("code");

            if (code) {
                // 2. Envoyer ce code à NOTRE backend (la fonction serverless)
                const response = await fetch('/api/auth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ code: code }),
                });

                const data = await response.json();

                if (!response.ok || !data.access_token) {
                    throw new Error(data.error || "Échec de l'échange de token");
                }

                // 3. On a le token sécurisé ! On le sauvegarde.
                localStorage.setItem("twitch_token", data.access_token);
                window.location.replace("/profile.html");

            } else {
                // Twitch a renvoyé une erreur (ex: accès refusé)
                const error = urlParams.get("error_description");
                console.error("Authentification échouée:", error);
                window.location.replace(`/index.html?error=${error || 'auth_failed'}`);
            }
        } catch (error) {
            console.error("Erreur dans auth.html:", error);
            window.location.replace(`/index.html?error=${error.message || 'script_error'}`);
        }
    })();
</script>
</body>
</html>