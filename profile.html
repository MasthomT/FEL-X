<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="UTF-8">
			<title>Mon Profil - FEL-X</title>
			<link rel="stylesheet" href="style.css">
				<!DOCTYPE html>
				<html lang="fr">
					<head>
						<meta charset="UTF-8">
							<title>Mon Profil - FEL-X</title>
							<link rel="stylesheet" href="style.css">
								<style>
									/* --- ADAPTATION AU STYLE GLOBAL (R√âF√âRENCE CLIPS.HTML) --- */
									body {
									margin: 0;
									font-family: 'Segoe UI', sans-serif;
									background: var(--bg);
									color: white;
									}

									main {
									padding: 2rem;
									margin-left: 240px;
									min-height: 100vh;
									}

									/* --- √âCRAN DE CHARGEMENT --- */
									#loading-overlay {
									position: fixed;
									top: 0; left: 0;
									width: 100%; height: 100%;
									background: var(--bg); /* M√™me fond que le reste du site */
									z-index: 2000;
									display: flex;
									flex-direction: column;
									justify-content: center;
									align-items: center;
									color: white !important;
									}
									#loading-overlay h2 {
									color: white !important;
									letter-spacing: 2px;
									text-transform: uppercase;
									margin-bottom: 0.5rem;
									}
									#loading-overlay p {
									color: var(--text-dim) !important;
									}

									/* --- EN-T√äTE DU PROFIL --- */
									.profile-header {
									display: flex;
									align-items: center;
									gap: 25px;
									margin-bottom: 2rem;
									background: var(--surface);
									padding: 1.5rem 2rem;
									border-radius: 12px;
									border: 1px solid var(--border);
									position: relative;
									}
									.profile-header::before {
									content: '';
									position: absolute;
									left: 0; top: 0; bottom: 0;
									width: 4px;
									background: var(--accent);
									border-radius: 12px 0 0 12px;
									}

									#username {
									color: white !important;
									margin: 0;
									font-size: 2rem;
									font-weight: 700;
									}

									.avatar-large {
									width: 90px; height: 90px;
									border-radius: 50%;
									border: 3px solid var(--accent);
									object-fit: cover;
									}

									/* --- BADGES & STATS --- */
									.badges-list { display: flex; gap: 8px; margin-top: 8px; }
									.badge {
									padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 600;
									text-transform: uppercase; display: flex; align-items: center; gap: 5px;
									}
									.badge-sub { color: #eb0400; background: rgba(235, 4, 0, 0.1); border: 1px solid rgba(235, 4, 0, 0.2); }
									.badge-follow { color: var(--accent); background: rgba(0, 255, 136, 0.1); border: 1px solid var(--border); }

									.stats-mini-grid {
									display: grid;
									grid-template-columns: repeat(4, 1fr);
									gap: 1.5rem;
									margin-bottom: 2rem;
									}
									.stat-box {
									background: var(--surface);
									border: 1px solid var(--border);
									border-radius: 12px;
									padding: 1.5rem;
									text-align: center;
									}
									.stat-title { color: var(--text-dim); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 8px; }
									.stat-num { font-size: 1.5rem; font-weight: 700; color: white; }

									/* --- XP PROGRESSION --- */
									.xp-container { margin-bottom: 2rem; }
									.xp-text { display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-dim); margin-bottom: 8px; }
									.xp-bar-bg { width: 100%; height: 10px; background: var(--bg); border-radius: 8px; border: 1px solid var(--border); overflow: hidden; }
									.xp-fill { height: 100%; background: var(--accent); width: 0%; transition: width 1s ease; }

									/* --- PANNEAUX (IDENTIT√â / HISTORIQUE / SONDAGE) --- */
									.id-card, .card-panel {
									background: var(--surface);
									border: 1px solid var(--border);
									border-radius: 12px;
									padding: 1.5rem;
									margin-bottom: 2rem;
									}

									.id-title, .panel-title {
									color: var(--accent);
									font-weight: 700;
									margin-bottom: 1.5rem;
									display: flex;
									align-items: center;
									gap: 10px;
									}

									.id-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; }
									.id-label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-dim); }
									.id-value { font-size: 0.95rem; color: white; border-bottom: 1px dashed var(--border); padding-bottom: 4px; }

									.main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: start; }

									.history-list { list-style: none; padding: 0; margin: 0; }
									.history-item {
									display: flex; justify-content: space-between; padding: 12px 0;
									border-bottom: 1px solid var(--border); font-size: 0.9rem;
									}

									/* --- SONDAGE (STYLE CLIPS-LIKE) --- */
									.poll-option-container { position: relative; margin-bottom: 12px; cursor: pointer; }
									.poll-option-bg {
									background: var(--bg);
									height: 50px;
									border-radius: 8px;
									border: 1px solid var(--border);
									overflow: hidden;
									position: relative;
									}
									.poll-option-fill { background: var(--accent); opacity: 0.2; height: 100%; transition: width 0.8s ease; }
									.poll-option-label {
									position: absolute; top: 0; left: 0; width: 100%; height: 100%;
									display: flex; justify-content: space-between; align-items: center;
									padding: 0 15px; font-weight: 600; color: white;
									}

									@media (max-width: 1100px) { .main-grid { grid-template-columns: 1fr; } }
									@media (max-width: 800px) {
									main { margin-left: 0; padding: 1rem; }
									.stats-mini-grid { grid-template-columns: repeat(2, 1fr); }
									}
								</style>
							</head>
					<body>

						<nav class="sidebar">
							<a href="profile.html" class="logo">
								<img src="logo-felix.png">
									<span>FEL-X</span>
							</a>
							<a href="profile.html" class="nav-link active">
								<svg viewBox="0 0 24 24" fill="currentColor">
									<path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
								</svg> Profil
							</a>
							<a href="infos.html" class="nav-link">
								<svg viewBox="0 0 24 24" fill="currentColor">
									<path d="M11 7h2v2h-2zm0 4h2v6h-2zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
								</svg> Infos
							</a>
							<a href="leaderboard.html" class="nav-link">
								<svg viewBox="0 0 24 24" fill="currentColor">
									<path d="M16 11V3H8v8H2v10h20V11h-6zm-6-6h4v14h-4V5zm-6 6h4v8H4v-8zm16 8h-4v-8h4v8z"/>
								</svg> Classement
							</a>
							<a href="clips.html" class="nav-link">
								<svg viewBox="0 0 24 24" fill="currentColor">
									<path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/>
								</svg> Clips
							</a>
							<a href="felix.html" class="nav-link">
								<svg viewBox="0 0 24 24" fill="currentColor">
									<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
								</svg> F√©lix et moi
							</a>
							<a href="#" id="logout-btn" class="nav-link logout">D√©connexion</a>
						</nav>

						<main>
							<div id="loading-overlay">
								<h2>Initialisation...</h2>
								<p>R√©cup√©ration des donn√©es</p>
							</div>

							<div class="profile-header">
								<img id="avatar" class="avatar-large" src="">
									<div style="flex-grow:1;">
										<h1 id="username">Chargement...</h1>
										<div id="rank" style="color:var(--text-dim);">Rang #--</div>
										<div class="badges-list" id="badges-container"></div>
									</div>
								</div>

							<div class="xp-container">
								<div class="xp-text">
									<span style="color:white; font-weight:bold;">
										NIVEAU <span id="stat-level-text">1</span>
									</span>
									<span>
										<span id="current-xp">0</span> / <span id="next-level-xp">100</span> XP
									</span>
								</div>
								<div class="xp-bar-bg">
									<div class="xp-fill" id="xp-fill"></div>
								</div>
							</div>

							<div class="stats-mini-grid">
								<div class="stat-box">
									<div class="stat-title">Niveau</div>
									<div class="stat-num" id="stat-level">1</div>
								</div>
								<div class="stat-box">
									<div class="stat-title">Watchtime</div>
									<div class="stat-num" id="stat-watchtime">-</div>
								</div>
								<div class="stat-box">
									<div class="stat-title">XP Total</div>
									<div class="stat-num" id="stat-xp">0</div>
								</div>
								<div class="stat-box">
									<div class="stat-title">Abonnement</div>
									<div class="stat-num" id="stat-sub">...</div>
								</div>
							</div>

							<div class="id-card">
								<div class="id-title">IDENTIT√â VIEWER (IA)</div>
								<div class="id-grid" id="ai-id-content">
									<p style="color:var(--text-dim); font-style:italic;">F√©lix analyse vos interactions...</p>
								</div>
							</div>

							<div class="main-grid">
								<div class="card-panel">
									<h3 class="panel-title">üìú Historique XP</h3>
									<ul class="history-list" id="xp-history-list"></ul>
								</div>

								<div class="card-panel" id="poll-container" style="display:none;">
									<h3 class="panel-title">üìä Sondage en cours</h3>
									<p id="poll-question" style="font-weight:bold; color:white; margin-bottom:1.5rem; font-size:1.1rem;"></p>
									<div id="poll-options"></div>
								</div>
							</div>
						</main>

						<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
						<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
						<script src="app.js"></script>

						<script>
							const CLIENT_ID_VERCEL = "kgyfzs0k3wk8enx7p3pd6299ro4izv";
							const BROADCASTER_NAME = "masthom_";

							let db;
							let userVote = null;
							let currentPollData = null;

							function sanitize(k) {
							if (!k) return "";
							return k.toString().replace(/\//g, "-").replace(/\./g, "_").replace(/[\$#\[\]]/g, "");
							}

							function formatDate(timestamp) {
							if (!timestamp) return "Date inconnue";
							const d = new Date(timestamp);
							return d.toLocaleDateString('fr-FR') + " " + d.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
							}

							document.addEventListener("DOMContentLoaded", async () => {
							const token = checkAuth();
							if (!token) return;

							try {
							const headers = { 'Authorization': `Bearer ${token}`, 'Client-Id': CLIENT_ID_VERCEL };
							const userResp = await fetch('https://api.twitch.tv/helix/users', { headers });
							const userData = await userResp.json();
							const user = userData.data[0];
							const userKey = user.login.toLowerCase();
							localStorage.setItem('twitch_username', userKey);

							document.getElementById("username").textContent = user.display_name;
							document.getElementById("avatar").src = user.profile_image_url;

							db = firebase.database();

							db.ref('user_persistent_votes/' + userKey).on('value', snap => {
							const data = snap.val();
							if (data) {
							userVote = data.option;
							window.refreshPollUI();
							}
							});

							db.ref('current_poll').on('value', snap => {
							currentPollData = snap.val();
							window.refreshPollUI();
							document.getElementById("loading-overlay").style.display = "none";
							});

							window.refreshPollUI = function() {
							const poll = currentPollData;
							const container = document.getElementById('poll-container');
							const optionsDiv = document.getElementById('poll-options');

							if (!poll || !poll.active) {
							container.style.display = 'none';
							return;
							}

							container.style.display = 'block';
							document.getElementById('poll-question').textContent = poll.question;
							optionsDiv.innerHTML = "";

							poll.options.forEach(option => {
							const safeKey = sanitize(option);
							const percent = (poll.stats && poll.stats[safeKey]) ? poll.stats[safeKey] : 0;
							const isMyVote = (userVote === option);

							const wrapper = document.createElement('div');
							wrapper.className = "poll-option-container";
							wrapper.innerHTML = `
							<div class="poll-option-bg" style="border-color: ${isMyVote ? 'var(--accent)' : 'var(--border)'}">
								<div class="poll-option-fill" style="width: ${percent}%;"></div>
								<div class="poll-option-label">
									<span>${isMyVote ? '‚úÖ ' : ''}${option}</span>
									<span style="font-family: monospace;">${percent}%</span>
								</div>
							</div>`;

							wrapper.onclick = () => window.castVote(poll.id, option);
							optionsDiv.appendChild(wrapper);
							});
							};

							db.ref('viewer_data/xp_data/' + userKey).on('value', snap => {
							const data = snap.val();
							let xp = (data && typeof data === 'object') ? (data.xp || 0) : (data || 0);
							const level = calculateLevel(xp);

							document.getElementById("stat-level").textContent = level;
							document.getElementById("stat-level-text").textContent = level;
							document.getElementById("stat-xp").textContent = xp.toLocaleString();

							const wt = data?.watchtime_seconds || 0;
							document.getElementById("stat-watchtime").textContent = `${Math.floor(wt/3600)}h ${Math.floor((wt%3600)/60)}m`;

							const nextXp = Math.floor(100 * Math.pow(level, 2.2));
							const currXp = Math.floor(100 * Math.pow(level - 1, 2.2));
							const prog = ((xp - currXp) / (nextXp - currXp)) * 100;

							document.getElementById("xp-fill").style.width = Math.min(100, Math.max(0, prog)) + "%";
							document.getElementById("current-xp").textContent = xp.toLocaleString();
							document.getElementById("next-level-xp").textContent = nextXp.toLocaleString();
							});

							db.ref('viewer_data/history/' + userKey).limitToLast(15).on('value', snap => {
							const list = document.getElementById("xp-history-list");
							if (snap.val()) {
							list.innerHTML = "";
							Object.values(snap.val()).reverse().forEach(h => {
							list.innerHTML += `
							<li class="history-item">
								<div>
									<div style="color:white;">${h.reason}</div>
									<div style="font-size:0.75rem; color:var(--text-dim);">${formatDate(h.timestamp)}</div>
								</div>
								<div style="color: var(--accent); font-weight: 600;">+${h.amount} XP</div>
							</li>`;
							});
							}
							});

							db.ref('viewer_data/xp_data').once('value').then(snap => {
							const all = snap.val() || {};
							const sorted = Object.entries(all)
							.map(([k, v]) => ({ k, xp: (v && typeof v === 'object' ? v.xp : v) || 0 }))
							.sort((a, b) => b.xp - a.xp);
							const myRank = sorted.findIndex(u => u.k === userKey) + 1;
							document.getElementById("rank").textContent = myRank > 0 ? `Rang #${myRank}` : "Non class√©";
							});

							const chResp = await fetch(`https://api.twitch.tv/helix/users?login=${BROADCASTER_NAME}`, { headers });
							const chData = await chResp.json();
							const bId = chData.data[0].id;

							fetch(`https://api.twitch.tv/helix/subscriptions/user?broadcaster_id=${bId}&user_id=${user.id}`, { headers })
							.then(r => r.status === 200 ? r.json() : null)
							.then(d => {
							const bDiv = document.getElementById("badges-container");
							if (d?.data?.length > 0) {
							bDiv.innerHTML += `<div class="badge badge-sub">Abonn√©</div>`;
							document.getElementById("stat-sub").textContent = "Oui";
							} else {
							document.getElementById("stat-sub").textContent = "Non";
							}
							});

							} catch (e) { console.error("‚ùå Erreur Profil:", e); }
							});

							window.castVote = async function(pId, opt) {
							const name = localStorage.getItem('twitch_username');
							if (!name || !db) return;
							userVote = opt;
							window.refreshPollUI();
							try {
							await db.ref('poll_incoming_votes/' + name).set({
							poll_id: pId, option: opt, username: name,
							timestamp: firebase.database.ServerValue.TIMESTAMP
							});
							await db.ref('user_persistent_votes/' + name).set({ poll_id: pId, option: opt });
							} catch (e) { console.error("‚ùå Erreur Vote:", e); }
							};
						</script>
					</body>
				</html>
			