<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="UTF-8">
			<title>Mon Profil - FEL-X</title>
			<link rel="stylesheet" href="style.css">
				<style>
					/* --- STYLES SP√âCIFIQUES PROFIL --- */

					/* En-t√™te */
					.profile-header {
					display: flex; align-items: center; gap: 25px; margin-bottom: 2rem;
					background: var(--surface); padding: 1.5rem 2rem; border-radius: 16px; border: 1px solid var(--border);
					position: relative; overflow: hidden;
					}
					.profile-main-content {
					display: grid;
					grid-template-columns: 1fr 1fr; /* Deux colonnes √©gales */
					gap: 2rem;
					grid-column: 1 / -1;
					}
					.profile-header::before { /* Petite barre d√©corative */
					content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--accent);
					}
					.avatar-large {
					width: 90px; height: 90px; border-radius: 50%;
					border: 3px solid var(--accent); object-fit: cover;
					}

					/* Badges */
					.badges-list { display: flex; gap: 8px; margin-top: 8px; }
					.badge {
					padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 600;
					text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 5px;
					}
					.badge-sub { color: var(--live); background: rgba(233, 30, 99, 0.1); border: 1px solid rgba(233, 30, 99, 0.2); }
					.badge-follow { color: #43b581; background: rgba(67, 181, 129, 0.1); border: 1px solid rgba(67, 181, 129, 0.2); }
					.badge-creator { color: #FFD700; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.2); }

					/* Barre XP */
					.xp-container { grid-column: 1 / -1; margin-bottom: 0.5rem; }
					.xp-bar-bg { width: 100%; height: 8px; background: #111; border-radius: 4px; overflow: hidden; margin-top: 10px; }
					.xp-fill { height: 100%; background: linear-gradient(90deg, var(--twitch), var(--accent)); width: 0%; transition: width 1s ease; }
					.xp-text { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-dim); margin-top: 5px; }

					/* Bouton sondage */
					.poll-btn {
					background: rgba(255,255,255,0.05);
					border: 1px solid var(--border);
					color: white;
					padding: 12px;
					border-radius: 8px;
					cursor: pointer;
					text-align: left;
					transition: 0.2s;
					font-weight: 500;
					}
					.poll-btn:hover {
					background: var(--accent);
					border-color: var(--accent);
					transform: translateX(5px);
					}

					/* Stats Grid (4 blocs) */
					.stats-mini-grid {
					display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem;
					}
					.stat-box {
					background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 10px; padding: 15px; text-align: center;
					}
					.stat-title { color: var(--text-dim); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
					.stat-num { font-size: 1.4rem; font-weight: 700; color: white; }
					.stat-sub { font-size: 0.7rem; color: var(--text-dim); margin-top: 3px; display: block; }

					/* --- CARTE D'IDENTIT√â F√âLIX (NOUVEAU DESIGN) --- */
					.id-card-section { grid-column: 1 / -1; margin-bottom: 2rem; }
					.id-card {
					background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
					border: 1px solid var(--border); border-radius: 16px; padding: 2rem;
					position: relative;
					}
					.id-card-header {
					display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border);
					padding-bottom: 15px; margin-bottom: 20px;
					}
					.id-title { font-size: 1.1rem; font-weight: 600; color: var(--accent); display: flex; align-items: center; gap: 10px; }
					.id-edit { font-size: 0.8rem; color: var(--text-dim); text-decoration: none; border: 1px solid var(--border); padding: 4px 10px; border-radius: 4px; transition: 0.2s; }
					.id-edit:hover { color: white; border-color: var(--accent); }

					.id-grid {
					display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;
					}
					.id-field { display: flex; flex-direction: column; gap: 4px; }
					.id-label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-dim); letter-spacing: 0.5px; }
					.id-value { font-size: 0.95rem; color: white; font-weight: 500; border-bottom: 1px dashed rgba(255,255,255,0.1); padding-bottom: 2px; }

					.id-bio { grid-column: 1 / -1; margin-top: 10px; }
					.id-bio .id-value { border: none; font-style: italic; color: #ddd; line-height: 1.5; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; }

					/* Historique */
					.history-header { font-size: 1rem; color: white; margin-bottom: 10px; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
					.history-list {
					list-style: none;
					padding: 0;
					max-height: none;
					overflow-y: visible;
					}
					.history-item {
					display: flex; justify-content: space-between; padding: 8px 0;
					border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 0.9rem;
					}
					.history-reason { color: #ccc; }
					.history-val { color: var(--accent); font-weight: 600; }
					.history-date { color: var(--text-dim); font-size: 0.8rem; min-width: 120px; text-align: right; }

					#loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }

					@media (max-width: 1200px) {
					/* Sur tablette, on garde l'identit√© en haut et on met l'historique/sondage sur une ligne en dessous */
					.profile-main-row {
					grid-template-columns: 1fr !important;
					}
					}

					@media (max-width: 800px) {
					/* Sur mobile, tout le monde prend 100% de largeur et s'empile verticalement */
					.profile-main-row div[style*="display: grid"] {
					grid-template-columns: 1fr !important;
					}

					.stats-mini-grid {
					grid-template-columns: repeat(2, 1fr); /* Les stats passent de 4 √† 2 colonnes */
					}
					}
				</style>
			</head>
	<body>

		<nav class="sidebar">
			<a href="profile.html" class="logo">
				<img src="logo-felix.png">
					<span>FEL-X</span>
				</a>
			<a href="profile.html" class="nav-link active">
				<svg viewBox="0 0 24 24" fill="currentColor">
					<path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
				</svg> Profil
			</a>
			<a href="infos.html" class="nav-link">
				<svg viewBox="0 0 24 24" fill="currentColor">
					<path d="M11 7h2v2h-2zm0 4h2v6h-2zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
				</svg> Infos
			</a>
			<a href="leaderboard.html" class="nav-link">
				<svg viewBox="0 0 24 24" fill="currentColor">
					<path d="M16 11V3H8v8H2v10h20V11h-6zm-6-6h4v14h-4V5zm-6 6h4v8H4v-8zm16 8h-4v-8h4v8z"/>
				</svg> Classement
			</a>
			<a href="clips.html" class="nav-link">
				<svg viewBox="0 0 24 24" fill="currentColor">
					<path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/>
				</svg> Clips
			</a>
			<a href="commands.html" class="nav-link">
				<svg viewBox="0 0 24 24" fill="currentColor">
					<path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
				</svg> Commandes
			</a>
			<a href="stats.html" class="nav-link">
				<svg viewBox="0 0 24 24" fill="currentColor">
					<path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 3c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm0 14c-2.03 0-4.43-.82-6.14-2.88a9.947 9.947 0 0 1 12.28 0C16.43 19.18 14.03 20 12 20z"/>
				</svg> Stats
			</a>
			<a href="felix.html" class="nav-link">
				<svg viewBox="0 0 24 24" fill="currentColor">
					<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
				</svg> F√©lix et moi
			</a>
			<a href="#" id="logout-btn" class="nav-link logout">D√©connexion</a>
		</nav>

		<main>
			<div id="loading-overlay">
				<h2>Connexion...</h2>
				<p style="color:var(--text-dim)">Chargement du profil</p>
			</div>

			<div class="profile-header">
				<img id="avatar" class="avatar-large" src="">
					<div style="flex-grow:1;">
						<h1 id="username" style="margin:0;">...</h1>
						<div id="rank" style="color:var(--text-dim);">Rang #--</div>
						<div class="badges-list" id="badges-container"></div>
					</div>
				</div>

			<div class="xp-container" style="margin-bottom: 2rem;">
				<div class="xp-text">
					<span style="color:white; font-weight:600;">PROGRESSION</span>
					<span>
						<span id="current-xp">0</span> / <span id="next-level-xp">100</span> XP
					</span>
				</div>
				<div class="xp-bar-bg">
					<div class="xp-fill" id="xp-fill"></div>
				</div>
			</div>

			<div class="stats-mini-grid">
				<div class="stat-box">
					<div class="stat-title">Niveau</div>
					<div class="stat-num" id="stat-level">1</div>
				</div>
				<div class="stat-box">
					<div class="stat-title">Watchtime</div>
					<div id="stat-watchtime" class="stat-num">-</div>
				</div>
				<div class="stat-box">
					<div class="stat-title">XP Total</div>
					<div class="stat-num" id="stat-xp">0</div>
				</div>
				<div class="stat-box">
					<div class="stat-title">Abonnement</div>
					<div class="stat-num" id="stat-sub">...</div>
					<div class="stat-sub" id="stat-sub-detail"></div>
				</div>
			</div>

			<div class="id-card-section" style="margin-top: 2rem; margin-bottom: 2rem;">
				<div class="id-card">
					<div class="id-card-header">
						<span class="id-title">
							<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
								<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
							</svg>
							IDENTIT√â VIEWER
						</span>
						<a href="felix.html" class="id-edit">Modifier</a>
					</div>
					<div class="id-grid" id="ai-id-content">
						<p style="color: var(--text-dim); font-style: italic;">F√©lix est en train d'apprendre √† vous conna√Ætre...</p>
					</div>
				</div>
			</div>

			<div class="profile-main-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: start;">

				<div class="history-card" style="background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem;">
					<div class="history-header" style="font-size: 1rem; color: white; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;">
						üìú Historique XP
					</div>
					<ul class="history-list" id="xp-history-list">
					</ul>
				</div>

				<div class="card poll-card" id="poll-container" style="display:none; background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem;">
					<h3 style="color: var(--accent); margin-bottom: 10px;">üìä Sondage en cours</h3>
					<p id="poll-question" style="margin-bottom: 1.5rem; font-weight: bold; color: white; font-size: 1.1rem;"></p>
					<div id="poll-options" style="display: flex; flex-direction: column; gap: 12px;">
					</div>
				</div>

			</div>
		</main>

		<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
		<script src="app.js"></script>

		<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
		<script src="app.js"></script>

		<script>
			// --- 1. CONFIGURATION ET VARIABLES GLOBALES ---
			const CLIENT_ID_VERCEL = "kgyfzs0k3wk8enx7p3pd6299ro4izv";
			const BROADCASTER_NAME = "masthom_";

			let db;
			let userVote = null;      // Choix m√©moris√© (le ‚úÖ)
			let currentPollData = null; // Donn√©es re√ßues (Stats)

			// Nettoyage des cl√©s pour Firebase (Identique au Python du Pi)
			// On remplace / par - et . par _
			function sanitize(k) {
			if (!k) return "";
			return k.toString().replace(/\//g, "-").replace(/\./g, "_").replace(/[\$#\[\]]/g, "");
			}

			function formatDate(timestamp) {
			if (!timestamp) return "Date inconnue";
			const d = new Date(timestamp);
			return d.toLocaleDateString('fr-FR') + " " + d.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
			}

			// --- 2. INITIALISATION ET LOGIQUE PRINCIPALE ---
			document.addEventListener("DOMContentLoaded", async () => {
			const token = checkAuth();
			if (!token) return;

			try {
			const headers = { 'Authorization': `Bearer ${token}`, 'Client-Id': CLIENT_ID_VERCEL };

			// A. Infos du Viewer
			const userResp = await fetch('https://api.twitch.tv/helix/users', { headers });
			const userData = await userResp.json();
			const user = userData.data[0];
			const userKey = user.login.toLowerCase();
			localStorage.setItem('twitch_username', userKey);

			document.getElementById("username").textContent = user.display_name;
			document.getElementById("avatar").src = user.profile_image_url;

			// B. ID de Masthom pour les badges
			const channelResp = await fetch(`https://api.twitch.tv/helix/users?login=${BROADCASTER_NAME}`, { headers });
			const channelData = await channelResp.json();
			const broadcasterId = channelData.data[0].id;

			db = firebase.database();

			// --- 3. √âCOUTES TEMPS R√âEL (FIREBASE) ---

			// √âcoute du vote PERSISTANT (Le ‚úÖ qui reste apr√®s actualisation)
			db.ref('user_persistent_votes/' + userKey).on('value', snap => {
			const data = snap.val();
			if (data) {
			userVote = data.option;
			window.refreshPollUI(); // Mise √† jour visuelle
			}
			});

			// √âcoute du sondage (Question + Stats)
			db.ref('current_poll').on('value', snapshot => {
			currentPollData = snapshot.val();
			window.refreshPollUI();
			document.getElementById("loading-overlay").style.display = "none";
			});

			// --- 4. FONCTION DE RENDU (Globale pour castVote) ---
			window.refreshPollUI = function() {
			const poll = currentPollData;
			const container = document.getElementById('poll-container');
			const optionsDiv = document.getElementById('poll-options');

			if (!poll || !poll.active) {
			container.style.display = 'none';
			return;
			}

			container.style.display = 'block';
			document.getElementById('poll-question').textContent = poll.question;
			optionsDiv.innerHTML = "";

			poll.options.forEach(option => {
			// On nettoie le texte pour trouver la stat (ex: 22/23h -> 22-23h)
			const safeKey = sanitize(option);
			const percent = (poll.stats && poll.stats[safeKey]) ? poll.stats[safeKey] : 0;
			const isMyVote = (userVote === option);

			const optBtn = document.createElement('div');
			optBtn.style = "position: relative; margin-bottom: 12px; cursor: pointer;";
			optBtn.innerHTML = `
			<div style="background: rgba(255,255,255,0.05); height: 50px; border-radius: 10px; border: 1px solid ${isMyVote ? 'var(--accent)' : 'var(--border)'}; overflow: hidden; position: relative;">
				<div style="background: var(--accent); opacity: ${isMyVote ? '0.4' : '0.15'}; height: 100%; width: ${percent}%; transition: width 0.8s ease;"></div>
				<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; font-weight: 600; color: white;">
					<span>${isMyVote ? '‚úÖ ' : ''}${option}</span>
					<span style="font-family: monospace; font-size: 1.1rem;">${percent}%</span>
				</div>
			</div>`;

			optBtn.onclick = () => window.castVote(poll.id, option);
			optionsDiv.appendChild(optBtn);
			});
			};

			// --- 5. LOGIQUE XP & HISTORIQUE ---
			db.ref('viewer_data/xp_data/' + userKey).on('value', snapshot => {
			const data = snapshot.val();
			let xp = (data && typeof data === 'object') ? (data.xp || 0) : (data || 0);
			const level = calculateLevel(xp);
			document.getElementById("stat-level").textContent = level;
			document.getElementById("stat-xp").textContent = xp.toLocaleString();
			const nextLevelXp = Math.floor(100 * Math.pow(level, 2.2));
			const currentLevelXp = Math.floor(100 * Math.pow(level - 1, 2.2));
			const progress = ((xp - currentLevelXp) / (nextLevelXp - currentLevelXp)) * 100;
			document.getElementById("xp-fill").style.width = Math.min(100, Math.max(0, progress)) + "%";
			document.getElementById("current-xp").textContent = xp.toLocaleString();
			document.getElementById("next-level-xp").textContent = nextLevelXp.toLocaleString();
			});

			db.ref('viewer_data/history/' + userKey).limitToLast(15).on('value', snap => {
			const listEl = document.getElementById("xp-history-list");
			if (snap.val()) {
			listEl.innerHTML = "";
			Object.values(snap.val()).reverse().forEach(item => {
			listEl.innerHTML += `<li class="history-item">
				<div>
					<div class="history-reason">${item.reason}</div>
					<div class="history-date">${formatDate(item.timestamp)}</div>
				</div>
				<div class="history-val">+${item.amount} XP</div>
			</li>`;
			});
			}
			});

			// --- 6. BADGES ET SUBS ---
			const badgesDiv = document.getElementById("badges-container");
			fetch(`https://api.twitch.tv/helix/channels/followed?user_id=${user.id}&broadcaster_id=${broadcasterId}`, { headers })
			.then(r => r.json()).then(d => {
			if (d.data && d.data.length > 0) badgesDiv.innerHTML += `<div class="badge badge-follow">Follower</div>`;
			});

			if (user.id !== broadcasterId) {
			fetch(`https://api.twitch.tv/helix/subscriptions/user?broadcaster_id=${broadcasterId}&user_id=${user.id}`, { headers })
			.then(r => r.status === 200 ? r.json() : null)
			.then(data => {
			if (data && data.data && data.data.length > 0) {
			badgesDiv.innerHTML += `<div class="badge badge-sub">Abonn√©</div>`;
			document.getElementById("stat-sub").textContent = "Oui";
			} else {
			document.getElementById("stat-sub").textContent = "Non";
			}
			});
			} else {
			badgesDiv.innerHTML += `<div class="badge badge-creator">Cr√©ateur</div>`;
			document.getElementById("stat-sub").textContent = "Cr√©ateur";
			}

			} catch (e) { console.error("‚ùå Erreur Profil:", e); }
			});

			// --- 7. ACTION DE VOTE (Globale) ---
			window.castVote = async function(pollId, option) {
			const username = localStorage.getItem('twitch_username');
			if (!username || !db) return;

			console.log(`üó≥Ô∏è Envoi du vote : ${option}`);

			try {
			await db.ref('poll_incoming_votes/' + username).set({
			poll_id: pollId,
			option: option,
			username: username,
			timestamp: firebase.database.ServerValue.TIMESTAMP
			});

			// MISE √Ä JOUR VISUELLE IMM√âDIATE
			userVote = option;
			window.refreshPollUI();
			console.log("‚úÖ Vote transmis au Cloud !");
			} catch (e) {
			console.error("‚ùå Erreur Firebase Vote:", e);
			}
			};
		</script>
	</body>
</html>