<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil | FEL-X</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="sidebar">
        <a href="profile.html" class="logo">
            <img src="logo-felix.png" alt="FEL-X">
            <span>FEL-X</span>
        </a>
        <div class="nav-menu">
            <a href="profile.html" class="nav-link active">Profil</a>
            <a href="infos.html" class="nav-link">Infos</a>
            <a href="leaderboard.html" class="nav-link">Classement</a>
            <a href="clips.html" class="nav-link">Clips</a>
            <a href="commands.html" class="nav-link">Commandes</a>
            <a href="stats.html" class="nav-link">Stats</a>
            <a href="felix.html" class="nav-link">F√©lix et moi</a>
        </div>
        <a href="#" id="logout-btn" class="nav-link logout">D√©connexion</a>
    </nav>

    <main class="content">
        <div id="loading-overlay">Chargement de ton univers...</div>

        <section id="profile-view" style="display: none;">
            <div class="profile-header card">
                <div class="avatar-container">
                    <img id="user-avatar" class="avatar-large" src="" alt="Avatar">
                </div>
                <div class="header-info">
                    <h1 id="user-name">Chargement...</h1>
                    <div id="user-badges" class="badges-row">
                        </div>
                </div>
                <div class="level-box">
                    <span class="lvl-tag">NIVEAU</span>
                    <span id="user-level" class="lvl-val">1</span>
                </div>
            </div>

            <div class="profile-grid">
                <div class="card xp-card">
                    <div class="card-title-row">
                        <h3>Progression XP</h3>
                        <span id="xp-text" class="xp-count">0 / 0 XP</span>
                    </div>
                    <div class="xp-track">
                        <div id="xp-fill" class="xp-bar"></div>
                    </div>
                    <p class="xp-info">Gagne de l'XP en √©tant actif sur le chat !</p>
                </div>

                <div class="stats-mini-container">
                    <div class="card mini-stat">
                        <span class="mini-label">Messages</span>
                        <span id="stat-messages" class="mini-val">-</span>
                    </div>
                    <div class="card mini-stat">
                        <span class="mini-label">Watchtime</span>
                        <span id="stat-watchtime" class="mini-val">0h</span>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="config.js"></script>
    <script src="app.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const token = checkAuth(); // Fonction dans app.js
            if (!token) return;

            try {
                // 1. R√©cup√©ration Profil Twitch
                const twResp = await fetch('https://api.twitch.tv/helix/users', {
                    headers: { 'Authorization': `Bearer ${token}`, 'Client-Id': CONFIG.CLIENT_ID }
                });
                const twData = await twResp.json();
                const user = twData.data[0];

                document.getElementById("user-name").textContent = user.display_name;
                document.getElementById("user-avatar").src = user.profile_image_url;

                // 2. R√©cup√©ration Stats depuis ton Raspberry (via Ngrok dans config.js)
                const sqlResp = await fetch(`${CONFIG.SERVER_URL}/api/user_stats/${user.id}`, {
                    headers: { 'ngrok-skip-browser-warning': 'true' }
                });
                
                if (sqlResp.ok) {
                    const data = await sqlResp.json();
                    
                    // Calcul Niveau & XP
                    const level = calculateLevel(data.xp); // Fonction dans app.js
                    const currentLevelXP = Math.pow((level - 1), 2.2) * 100;
                    const nextLevelXP = Math.pow(level, 2.2) * 100;
                    const progress = ((data.xp - currentLevelXP) / (nextLevelXP - currentLevelXP)) * 100;

                    document.getElementById("user-level").textContent = level;
                    document.getElementById("xp-text").textContent = `${Math.floor(data.xp)} / ${Math.floor(nextLevelXP)} XP`;
                    document.getElementById("xp-fill").style.width = `${Math.min(100, progress)}%`;

                    // Stats
                    document.getElementById("stat-messages").textContent = data.message_count || 0;
                    const h = Math.floor((data.watchtime_seconds || 0) / 3600);
                    document.getElementById("stat-watchtime").textContent = `${h}h`;

                    // Badges
                    const badges = document.getElementById("user-badges");
                    if (data.is_mod) badges.innerHTML += `<span class="badge b-mod">üõ°Ô∏è Mod√©rateur</span>`;
                    if (data.is_vip) badges.innerHTML += `<span class="badge b-vip">üíé VIP</span>`;
                }

                document.getElementById("loading-overlay").style.display = "none";
                document.getElementById("profile-view").style.display = "block";

            } catch (err) {
                console.error("Erreur de chargement:", err);
                document.getElementById("loading-overlay").innerHTML = "<p>Erreur de liaison avec le serveur.</p>";
            }
        });
    </script>
</body>
</html>