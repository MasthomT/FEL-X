<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="UTF-8">
			<title>Mon Profil - FEL-X</title>
			<link rel="stylesheet" href="style.css">
				<style>
					/* --- STYLES SP√âCIFIQUES PROFIL --- */
					.profile-header {
					display: flex; align-items: center; gap: 25px; margin-bottom: 2rem;
					background: var(--surface); padding: 1.5rem 2rem; border-radius: 16px; border: 1px solid var(--border);
					position: relative; overflow: hidden;
					}
					.profile-header::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--accent); }
					.avatar-large { width: 90px; height: 90px; border-radius: 50%; border: 3px solid var(--accent); object-fit: cover; }

					.badges-list { display: flex; gap: 8px; margin-top: 8px; }
					.badge { padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; display: flex; align-items: center; gap: 5px; }
					.badge-sub { color: var(--live); background: rgba(233, 30, 99, 0.1); border: 1px solid rgba(233, 30, 99, 0.2); }
					.badge-follow { color: #43b581; background: rgba(67, 181, 129, 0.1); border: 1px solid rgba(67, 181, 129, 0.2); }
					.badge-creator { color: #FFD700; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.2); }

					.xp-container { grid-column: 1 / -1; margin-bottom: 0.5rem; }
					.xp-bar-bg { width: 100%; height: 8px; background: #111; border-radius: 4px; overflow: hidden; margin-top: 10px; }
					.xp-fill { height: 100%; background: linear-gradient(90deg, var(--twitch), var(--accent)); width: 0%; transition: width 1s ease; }
					.xp-text { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-dim); margin-top: 5px; }

					.stats-mini-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem; }
					.stat-box { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 10px; padding: 15px; text-align: center; }
					.stat-title { color: var(--text-dim); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 5px; }
					.stat-num { font-size: 1.4rem; font-weight: 700; color: white; }

					.id-card { background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); border: 1px solid var(--border); border-radius: 16px; padding: 2rem; }
					.id-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
					.id-field { display: flex; flex-direction: column; gap: 4px; }
					.id-label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-dim); }
					.id-value { font-size: 0.95rem; color: white; font-weight: 500; border-bottom: 1px dashed rgba(255,255,255,0.1); padding-bottom: 2px; }

					.history-list { list-style: none; padding: 0; }
					.history-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 0.9rem; }
					.history-val { color: var(--accent); font-weight: 600; }

					#loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0b0b0b; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
				</style>
			</head>
	<body>

		<nav class="sidebar">
			<a href="profile.html" class="logo">
				<img src="logo-felix.png">
					<span>FEL-X</span>
			</a>
			<a href="profile.html" class="nav-link active">Profil</a>
			<a href="infos.html" class="nav-link">Infos</a>
			<a href="leaderboard.html" class="nav-link">Classement</a>
			<a href="felix.html" class="nav-link">F√©lix et moi</a>
			<a href="#" id="logout-btn" class="nav-link logout">D√©connexion</a>
		</nav>

		<main>
			<div id="loading-overlay">
				<h2>Connexion...</h2>
				<p style="color:var(--text-dim)">Chargement du profil</p>
			</div>

			<div class="profile-header">
				<img id="avatar" class="avatar-large" src="">
					<div style="flex-grow:1;">
						<h1 id="username" style="margin:0;">...</h1>
						<div id="rank" style="color:var(--text-dim);">Rang #--</div>
						<div class="badges-list" id="badges-container"></div>
					</div>
				</div>

			<div class="xp-container">
				<div class="xp-text">
					<span style="color:white; font-weight:600;">PROGRESSION</span>
					<span>
						<span id="current-xp">0</span> / <span id="next-level-xp">100</span> XP
					</span>
				</div>
				<div class="xp-bar-bg">
					<div class="xp-fill" id="xp-fill"></div>
				</div>
			</div>

			<div class="stats-mini-grid">
				<div class="stat-box">
					<div class="stat-title">Niveau</div>
					<div class="stat-num" id="stat-level">1</div>
				</div>
				<div class="stat-box">
					<div class="stat-title">Watchtime</div>
					<div id="stat-watchtime" class="stat-num">-</div>
				</div>
				<div class="stat-box">
					<div class="stat-title">XP Total</div>
					<div class="stat-num" id="stat-xp">0</div>
				</div>
				<div class="stat-box">
					<div class="stat-title">Abonnement</div>
					<div class="stat-num" id="stat-sub">...</div>
				</div>
			</div>

			<div class="id-card-section" style="margin: 2rem 0;">
				<div class="id-card">
					<div class="id-card-header" style="margin-bottom:20px; color:var(--accent); font-weight:bold;">IDENTIT√â VIEWER</div>
					<div class="id-grid" id="ai-id-content">
						<p style="color: var(--text-dim); font-style: italic;">F√©lix apprend √† vous conna√Ætre...</p>
					</div>
				</div>
			</div>

			<div class="profile-main-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
				<div class="history-card" style="background: var(--surface); border-radius: 16px; padding: 1.5rem; border: 1px solid var(--border);">
					<div class="history-header" style="color:white; margin-bottom:15px; border-bottom:1px solid var(--border); padding-bottom:10px;">üìú Historique XP</div>
					<ul class="history-list" id="xp-history-list"></ul>
				</div>

				<div class="card poll-card" id="poll-container" style="display:none; background: var(--surface); border-radius: 16px; padding: 1.5rem; border: 1px solid var(--border);">
					<h3 style="color: var(--accent); margin-bottom: 10px;">üìä Sondage en cours</h3>
					<p id="poll-question" style="margin-bottom: 1.5rem; font-weight: bold; color: white;"></p>
					<div id="poll-options" style="display: flex; flex-direction: column; gap: 12px;"></div>
				</div>
			</div>
		</main>

		<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
		<script src="app.js"></script>

		<script>
			// --- 1. CONFIGURATION ---
			const CLIENT_ID_VERCEL = "kgyfzs0k3wk8enx7p3pd6299ro4izv";
			const BROADCASTER_NAME = "masthom_";

			let db;
			let userVote = null;
			let currentPollData = null;

			// Nettoyage des cl√©s (Identique au Python du Pi : remplace / par - et . par _)
			function sanitize(k) {
			if (!k) return "";
			return k.toString().replace(/\//g, "-").replace(/\./g, "_").replace(/[\$#\[\]]/g, "");
			}

			function formatDate(timestamp) {
			if (!timestamp) return "Date inconnue";
			const d = new Date(timestamp);
			return d.toLocaleDateString('fr-FR') + " " + d.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
			}

			// --- 2. LOGIQUE INITIALE ---
			document.addEventListener("DOMContentLoaded", async () => {
			const token = checkAuth();
			if (!token) return;

			try {
			const headers = { 'Authorization': `Bearer ${token}`, 'Client-Id': CLIENT_ID_VERCEL };

			// A. Infos Viewer
			const userResp = await fetch('https://api.twitch.tv/helix/users', { headers });
			const userData = await userResp.json();
			const user = userData.data[0];
			const userKey = user.login.toLowerCase();
			localStorage.setItem('twitch_username', userKey);

			document.getElementById("username").textContent = user.display_name;
			document.getElementById("avatar").src = user.profile_image_url;

			// B. ID Broadcaster
			const channelResp = await fetch(`https://api.twitch.tv/helix/users?login=${BROADCASTER_NAME}`, { headers });
			const channelData = await channelResp.json();
			const broadcasterId = channelData.data[0].id;

			db = firebase.database();

			// --- 3. √âCOUTES FIREBASE ---

			// Vote PERSISTANT (Le ‚úÖ qui reste au refresh)
			db.ref('user_persistent_votes/' + userKey).on('value', snap => {
			const data = snap.val();
			if (data) {
			userVote = data.option;
			window.refreshPollUI();
			}
			});

			// Donn√©es Sondage (Stats)
			db.ref('current_poll').on('value', snapshot => {
			currentPollData = snapshot.val();
			window.refreshPollUI();
			document.getElementById("loading-overlay").style.display = "none";
			});

			// --- 4. RENDU INTERFACE ---
			window.refreshPollUI = function() {
			const poll = currentPollData;
			const container = document.getElementById('poll-container');
			const optionsDiv = document.getElementById('poll-options');

			if (!poll || !poll.active) {
			container.style.display = 'none';
			return;
			}

			container.style.display = 'block';
			document.getElementById('poll-question').textContent = poll.question;
			optionsDiv.innerHTML = "";

			poll.options.forEach(option => {
			const safeKey = sanitize(option);
			const percent = (poll.stats && poll.stats[safeKey]) ? poll.stats[safeKey] : 0;
			const isMyVote = (userVote === option);

			const optBtn = document.createElement('div');
			optBtn.style = "position: relative; margin-bottom: 12px; cursor: pointer;";
			optBtn.innerHTML = `
			<div style="background: rgba(255,255,255,0.05); height: 50px; border-radius: 10px; border: 1px solid ${isMyVote ? 'var(--accent)' : 'var(--border)'}; overflow: hidden; position: relative;">
				<div style="background: var(--accent); opacity: ${isMyVote ? '0.4' : '0.15'}; height: 100%; width: ${percent}%; transition: width 0.8s ease;"></div>
				<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; font-weight: 600; color: white;">
					<span>${isMyVote ? '‚úÖ ' : ''}${option}</span>
					<span style="font-family: monospace; font-size: 1.1rem;">${percent}%</span>
				</div>
			</div>`;

			optBtn.onclick = () => window.castVote(poll.id, option);
			optionsDiv.appendChild(optBtn);
			});
			};

			// --- 5. XP & HISTORIQUE ---
			db.ref('viewer_data/xp_data/' + userKey).on('value', snapshot => {
			const data = snapshot.val();
			let xp = (data && typeof data === 'object') ? (data.xp || 0) : (data || 0);
			const level = calculateLevel(xp);
			document.getElementById("stat-level").textContent = level;
			document.getElementById("stat-xp").textContent = xp.toLocaleString();
			const nextLevelXp = Math.floor(100 * Math.pow(level, 2.2));
			const currentLevelXp = Math.floor(100 * Math.pow(level - 1, 2.2));
			const progress = ((xp - currentLevelXp) / (nextLevelXp - currentLevelXp)) * 100;
			document.getElementById("xp-fill").style.width = Math.min(100, Math.max(0, progress)) + "%";
			document.getElementById("current-xp").textContent = xp.toLocaleString();
			document.getElementById("next-level-xp").textContent = nextLevelXp.toLocaleString();

			const wt_seconds = (data && data.watchtime_seconds) ? data.watchtime_seconds : 0;
			const h = Math.floor(wt_seconds / 3600);
			const m = Math.floor((wt_seconds % 3600) / 60);
			document.getElementById("stat-watchtime").textContent = `${h}h ${m}m`;
			});

			db.ref('viewer_data/history/' + userKey).limitToLast(15).on('value', snap => {
			const listEl = document.getElementById("xp-history-list");
			if (snap.val()) {
			listEl.innerHTML = "";
			Object.values(snap.val()).reverse().forEach(item => {
			listEl.innerHTML += `<li class="history-item">
				<div>
					<div style="color:white;">${item.reason}</div>
					<div style="font-size:0.75rem; color:var(--text-dim);">${formatDate(item.timestamp)}</div>
				</div>
				<div class="history-val">+${item.amount} XP</div>
			</li>`;
			});
			}
			});

			// --- 6. BADGES ---
			const badgesDiv = document.getElementById("badges-container");
			fetch(`https://api.twitch.tv/helix/channels/followed?user_id=${user.id}&broadcaster_id=${broadcasterId}`, { headers })
			.then(r => r.json()).then(d => {
			if (d.data && d.data.length > 0) badgesDiv.innerHTML += `<div class="badge badge-follow">Follower</div>`;
			});

			if (user.id !== broadcasterId) {
			fetch(`https://api.twitch.tv/helix/subscriptions/user?broadcaster_id=${broadcasterId}&user_id=${user.id}`, { headers })
			.then(r => r.status === 200 ? r.json() : null)
			.then(data => {
			if (data && data.data && data.data.length > 0) {
			badgesDiv.innerHTML += `<div class="badge badge-sub">Abonn√©</div>`;
			document.getElementById("stat-sub").textContent = "Oui";
			} else {
			document.getElementById("stat-sub").textContent = "Non";
			}
			});
			} else {
			badgesDiv.innerHTML += `<div class="badge badge-creator">Cr√©ateur</div>`;
			document.getElementById("stat-sub").textContent = "üëë";
			}

			} catch (e) { console.error("‚ùå Erreur Initialisation:", e); }
			});

			// --- 7. ACTION DE VOTE (Globale) ---
			window.castVote = async function(pollId, option) {
			const username = localStorage.getItem('twitch_username');
			if (!username || !db) return;

			console.log(`üó≥Ô∏è Envoi du vote : ${option} pour ${username}`);

			try {
			// √âcriture vers le Pi
			await db.ref('poll_incoming_votes/' + username).set({
			poll_id: pollId,
			option: option,
			username: username,
			timestamp: firebase.database.ServerValue.TIMESTAMP
			});

			// Retour visuel IMM√âDIAT
			userVote = option;
			window.refreshPollUI();
			console.log("‚úÖ Vote transmis au Cloud !");
			} catch (e) {
			console.error("‚ùå Erreur Firebase Vote:", e);
			alert("Erreur de connexion Firebase.");
			}
			};
		</script>
	</body>
</html>