<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="UTF-8">
			<title>Mon Profil - FEL-X</title>
			<link rel="stylesheet" href="style.css">
				<style>
					/* --- STYLES SPÃ‰CIFIQUES PROFIL --- */
					.profile-header {
					display: flex; align-items: center; gap: 25px; margin-bottom: 2rem;
					background: var(--surface); padding: 1.5rem 2rem; border-radius: 16px; border: 1px solid var(--border);
					position: relative; overflow: hidden;
					}
					.profile-header::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--accent); }
					.avatar-large { width: 90px; height: 90px; border-radius: 50%; border: 3px solid var(--accent); object-fit: cover; }

					.badges-list { display: flex; gap: 8px; margin-top: 8px; }
					.badge { padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; display: flex; align-items: center; gap: 5px; }
					.badge-sub { color: var(--live); background: rgba(233, 30, 99, 0.1); border: 1px solid rgba(233, 30, 99, 0.2); }
					.badge-follow { color: #43b581; background: rgba(67, 181, 129, 0.1); border: 1px solid rgba(67, 181, 129, 0.2); }
					.badge-creator { color: #FFD700; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.2); }

					.xp-container { grid-column: 1 / -1; margin-bottom: 0.5rem; }
					.xp-bar-bg { width: 100%; height: 8px; background: #111; border-radius: 4px; overflow: hidden; margin-top: 10px; }
					.xp-fill { height: 100%; background: linear-gradient(90deg, var(--twitch), var(--accent)); width: 0%; transition: width 1s ease; }
					.xp-text { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-dim); margin-top: 5px; }

					.stats-mini-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem; }
					.stat-box { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 10px; padding: 15px; text-align: center; }
					.stat-title { color: var(--text-dim); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 5px; }
					.stat-num { font-size: 1.4rem; font-weight: 700; color: white; }

					.id-card { background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); border: 1px solid var(--border); border-radius: 16px; padding: 2rem; }
					.id-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
					.id-field { display: flex; flex-direction: column; gap: 4px; }
					.id-label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-dim); }
					.id-value { font-size: 0.95rem; color: white; font-weight: 500; border-bottom: 1px dashed rgba(255,255,255,0.1); padding-bottom: 2px; }

					.history-list { list-style: none; padding: 0; }
					.history-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 0.9rem; }
					.history-val { color: var(--accent); font-weight: 600; }

					#loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0b0b0b; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
				</style>
			</head>
	<!DOCTYPE html>
	<html lang="fr">
		<head>
			<meta charset="UTF-8">
				<title>Mon Profil - FEL-X</title>
				<link rel="stylesheet" href="style.css">
					<style>
						/* Styles essentiels */
						.profile-header { display: flex; align-items: center; gap: 25px; margin-bottom: 2rem; background: var(--surface); padding: 1.5rem 2rem; border-radius: 16px; border: 1px solid var(--border); position: relative; overflow: hidden; }
						.profile-header::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--accent); }
						.avatar-large { width: 90px; height: 90px; border-radius: 50%; border: 3px solid var(--accent); object-fit: cover; }
						.badges-list { display: flex; gap: 8px; margin-top: 8px; }
						.badge { padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; display: flex; align-items: center; gap: 5px; }
						.badge-sub { color: var(--live); background: rgba(233, 30, 99, 0.1); border: 1px solid rgba(233, 30, 99, 0.2); }
						.badge-follow { color: #43b581; background: rgba(67, 181, 129, 0.1); border: 1px solid rgba(67, 181, 129, 0.2); }
						.badge-creator { color: #FFD700; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.2); }
						.xp-bar-bg { width: 100%; height: 8px; background: #111; border-radius: 4px; overflow: hidden; margin-top: 10px; }
						.xp-fill { height: 100%; background: linear-gradient(90deg, var(--twitch), var(--accent)); width: 0%; transition: width 1s ease; }
						.stats-mini-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem; }
						.stat-box { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 10px; padding: 15px; text-align: center; }
						.id-card { background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); border: 1px solid var(--border); border-radius: 16px; padding: 2rem; }
						.id-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
						.history-list { list-style: none; padding: 0; }
						.history-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.03); }
						#loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0b0b0b; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
					</style>
				</head>
		<body>

			<nav class="sidebar">
				<a href="profile.html" class="logo">
					<img src="logo-felix.png">
						<span>FEL-X</span>
				</a>
				<a href="profile.html" class="nav-link active">Profil</a>
				<a href="infos.html" class="nav-link">Infos</a>
				<a href="leaderboard.html" class="nav-link">Classement</a>
				<a href="felix.html" class="nav-link">FÃ©lix et moi</a>
				<a href="#" id="logout-btn" class="nav-link logout">DÃ©connexion</a>
			</nav>

			<main>
				<div id="loading-overlay">
					<h2>Connexion...</h2>
				</div>

				<div class="profile-header">
					<img id="avatar" class="avatar-large" src="">
						<div style="flex-grow:1;">
							<h1 id="username">...</h1>
							<div id="rank" style="color:var(--text-dim);">Rang #--</div>
							<div class="badges-list" id="badges-container"></div>
						</div>
					</div>

				<div class="xp-container" style="margin-bottom: 2rem;">
					<div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:5px;">
						<span style="font-weight:bold;">PROGRESSION</span>
						<span>
							<span id="current-xp">0</span> / <span id="next-level-xp">100</span> XP
						</span>
					</div>
					<div class="xp-bar-bg">
						<div class="xp-fill" id="xp-fill"></div>
					</div>
				</div>

				<div class="stats-mini-grid">
					<div class="stat-box">
						<div style="font-size:0.7rem; color:var(--text-dim);">NIVEAU</div>
						<div id="stat-level" style="font-size:1.5rem; font-weight:bold;">1</div>
					</div>
					<div class="stat-box">
						<div style="font-size:0.7rem; color:var(--text-dim);">WATCHTIME</div>
						<div id="stat-watchtime" style="font-size:1.5rem; font-weight:bold;">-</div>
					</div>
					<div class="stat-box">
						<div style="font-size:0.7rem; color:var(--text-dim);">XP TOTAL</div>
						<div id="stat-xp" style="font-size:1.5rem; font-weight:bold;">0</div>
					</div>
					<div class="stat-box">
						<div style="font-size:0.7rem; color:var(--text-dim);">ABONNÃ‰</div>
						<div id="stat-sub" style="font-size:1.5rem; font-weight:bold;">Non</div>
					</div>
				</div>

				<div class="id-card" style="margin-bottom: 2rem;">
					<div style="color:var(--accent); font-weight:bold; margin-bottom:15px;">IDENTITÃ‰ VIEWER (IA)</div>
					<div class="id-grid" id="ai-id-content">
						<p style="color:var(--text-dim); font-style:italic;">En attente de donnÃ©es IA...</p>
					</div>
				</div>

				<div style="display:grid; grid-template-columns:1fr 1fr; gap:2rem;">
					<div style="background:var(--surface); padding:1.5rem; border-radius:16px; border:1px solid var(--border);">
						<div style="color:white; border-bottom:1px solid var(--border); padding-bottom:10px; margin-bottom:15px;">ðŸ“œ HISTORIQUE XP</div>
						<ul class="history-list" id="xp-history-list"></ul>
					</div>

					<div id="poll-container" style="display:none; background:var(--surface); padding:1.5rem; border-radius:16px; border:1px solid var(--border);">
						<h3 style="color:var(--accent); margin-bottom:10px;">ðŸ“Š SONDAGE EN COURS</h3>
						<p id="poll-question" style="font-weight:bold; margin-bottom:1.5rem;"></p>
						<div id="poll-options" style="display:flex; flex-direction:column; gap:12px;"></div>
					</div>
				</div>
			</main>

			<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
			<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
			<script src="app.js"></script>

			<script>
				const CLIENT_ID_VERCEL = "kgyfzs0k3wk8enx7p3pd6299ro4izv";
				const BROADCASTER_NAME = "masthom_";

				let db;
				let userVote = null;
				let currentPollData = null;

				function sanitize(k) {
				if (!k) return "";
				return k.toString().replace(/\//g, "-").replace(/\./g, "_").replace(/[\$#\[\]]/g, "");
				}

				function formatDate(timestamp) {
				if (!timestamp) return "Date inconnue";
				const d = new Date(timestamp);
				return d.toLocaleDateString('fr-FR') + " " + d.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
				}

				document.addEventListener("DOMContentLoaded", async () => {
				const token = checkAuth();
				if (!token) return;

				try {
				const headers = { 'Authorization': `Bearer ${token}`, 'Client-Id': CLIENT_ID_VERCEL };

				// 1. Twitch Info
				const userResp = await fetch('https://api.twitch.tv/helix/users', { headers });
				const userData = await userResp.json();
				const user = userData.data[0];
				const userKey = user.login.toLowerCase();
				localStorage.setItem('twitch_username', userKey);

				document.getElementById("username").textContent = user.display_name;
				document.getElementById("avatar").src = user.profile_image_url;

				// 2. Firebase Database
				db = firebase.database();

				// 3. Sondage (Ecoute du âœ… durable)
				db.ref('user_persistent_votes/' + userKey).on('value', snap => {
				const data = snap.val();
				if (data) {
				userVote = data.option;
				window.refreshPollUI();
				}
				});

				// 4. Sondage (Stats globales)
				db.ref('current_poll').on('value', snap => {
				currentPollData = snap.val();
				window.refreshPollUI();
				document.getElementById("loading-overlay").style.display = "none";
				});

				window.refreshPollUI = function() {
				const poll = currentPollData;
				const container = document.getElementById('poll-container');
				const optionsDiv = document.getElementById('poll-options');

				if (!poll || !poll.active) {
				container.style.display = 'none';
				return;
				}

				container.style.display = 'block';
				document.getElementById('poll-question').textContent = poll.question;
				optionsDiv.innerHTML = "";

				poll.options.forEach(opt => {
				const sk = sanitize(opt);
				const pc = (poll.stats && poll.stats[sk]) ? poll.stats[sk] : 0;
				const mine = (userVote === opt);

				const b = document.createElement('div');
				b.style = "position:relative; cursor:pointer;";
				b.innerHTML = `
				<div style="background:rgba(255,255,255,0.05); height:48px; border-radius:8px; border:1px solid ${mine?'var(--accent)':'var(--border)'}; overflow:hidden; position:relative;">
					<div style="background:var(--accent); opacity:${mine?'0.4':'0.15'}; height:100%; width:${pc}%; transition:width 0.8s ease;"></div>
					<div style="position:absolute; top:0; left:0; width:100%; height:100%; display:flex; justify-content:space-between; align-items:center; padding:0 15px; color:white; font-weight:bold;">
						<span>${mine?'âœ… ':''}${opt}</span>
						<span>${pc}%</span>
					</div>
				</div>`;
				b.onclick = () => window.castVote(poll.id, opt);
				optionsDiv.appendChild(b);
				});
				};

				// 5. XP & Watchtime
				db.ref('viewer_data/xp_data/' + userKey).on('value', snap => {
				const d = snap.val();
				let xp = (d && typeof d === 'object') ? (d.xp || 0) : (d || 0);
				const lvl = calculateLevel(xp);
				document.getElementById("stat-level").textContent = lvl;
				document.getElementById("stat-xp").textContent = xp.toLocaleString();
				const wt = d?.watchtime_seconds || 0;
				document.getElementById("stat-watchtime").textContent = `${Math.floor(wt/3600)}h ${Math.floor((wt%3600)/60)}m`;

				const nxXp = Math.floor(100 * Math.pow(lvl, 2.2));
				const cuXp = Math.floor(100 * Math.pow(lvl-1, 2.2));
				document.getElementById("xp-fill").style.width = Math.min(100, Math.max(0, ((xp-cuXp)/(nxXp-cuXp))*100)) + "%";
				});

				// 6. Historique
				db.ref('viewer_data/history/' + userKey).limitToLast(10).on('value', snap => {
				const list = document.getElementById("xp-history-list");
				if (snap.val()) {
				list.innerHTML = "";
				Object.values(snap.val()).reverse().forEach(h => {
				list.innerHTML += `<li class="history-item">
					<span>${h.reason}</span>
					<span style="color:var(--accent)">+${h.amount} XP</span>
				</li>`;
				});
				}
				});

				// 7. Badges Twitch
				const chResp = await fetch(`https://api.twitch.tv/helix/users?login=${BROADCASTER_NAME}`, { headers });
				const chData = await chResp.json();
				const bId = chData.data[0].id;

				fetch(`https://api.twitch.tv/helix/channels/followed?user_id=${user.id}&broadcaster_id=${bId}`, { headers })
				.then(r => r.json()).then(d => {
				if (d.data?.length > 0) document.getElementById("badges-container").innerHTML += `<div class="badge badge-follow">Follower</div>`;
				});

				} catch (e) { console.error(e); }
				});

				window.castVote = async function(pId, opt) {
				const name = localStorage.getItem('twitch_username');
				if (!name || !db) return;
				// Retour optimiste
				userVote = opt;
				window.refreshPollUI();
				try {
				// Double Ã©criture pour la persistance immÃ©diate
				await db.ref('poll_incoming_votes/' + name).set({ poll_id: pId, option: opt, timestamp: firebase.database.ServerValue.TIMESTAMP });
				await db.ref('user_persistent_votes/' + name).set({ poll_id: pId, option: opt });
				} catch (e) { console.error(e); }
				};
			</script>
		</body>
	</html>