<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="UTF-8">
			<title>Mon Profil - FEL-X</title>
			<link rel="stylesheet" href="style.css">
				<!DOCTYPE html>
				<html lang="fr">
					<head>
						<meta charset="UTF-8">
							<title>Mon Profil - FEL-X</title>
							<link rel="stylesheet" href="style.css">
								<style>
									/* --- STYLES SP√âCIFIQUES PROFIL --- */
									.profile-header {
									display: flex; align-items: center; gap: 25px; margin-bottom: 2rem;
									background: var(--surface); padding: 1.5rem 2rem; border-radius: 16px; border: 1px solid var(--border);
									position: relative; overflow: hidden;
									}
									.profile-header::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--accent); }
									.avatar-large { width: 90px; height: 90px; border-radius: 50%; border: 3px solid var(--accent); object-fit: cover; }

									.badges-list { display: flex; gap: 8px; margin-top: 8px; }
									.badge { padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; display: flex; align-items: center; gap: 5px; }
									.badge-sub { color: var(--live); background: rgba(233, 30, 99, 0.1); border: 1px solid rgba(233, 30, 99, 0.2); }
									.badge-follow { color: #43b581; background: rgba(67, 181, 129, 0.1); border: 1px solid rgba(67, 181, 129, 0.2); }
									.badge-creator { color: #FFD700; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.2); }

									.xp-container { grid-column: 1 / -1; margin-bottom: 0.5rem; }
									.xp-bar-bg { width: 100%; height: 8px; background: #111; border-radius: 4px; overflow: hidden; margin-top: 10px; }
									.xp-fill { height: 100%; background: linear-gradient(90deg, var(--twitch), var(--accent)); width: 0%; transition: width 1s ease; }
									.xp-text { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-dim); margin-top: 5px; }

									.stats-mini-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem; }
									.stat-box { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 10px; padding: 15px; text-align: center; }
									.stat-title { color: var(--text-dim); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 5px; }
									.stat-num { font-size: 1.4rem; font-weight: 700; color: white; }

									.id-card { background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); border: 1px solid var(--border); border-radius: 16px; padding: 2rem; }
									.id-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
									.id-field { display: flex; flex-direction: column; gap: 4px; }
									.id-label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-dim); }
									.id-value { font-size: 0.95rem; color: white; font-weight: 500; border-bottom: 1px dashed rgba(255,255,255,0.1); padding-bottom: 2px; }

									.history-list { list-style: none; padding: 0; }
									.history-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 0.9rem; }
									.history-val { color: var(--accent); font-weight: 600; }

									#loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0b0b0b; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
								</style>
							</head>
					<body>

						<nav class="sidebar">
							<a href="profile.html" class="logo">
								<img src="logo-felix.png">
									<span>FEL-X</span>
								</a>
							<a href="profile.html" class="nav-link active">Profil</a>
							<a href="infos.html" class="nav-link">Infos</a>
							<a href="leaderboard.html" class="nav-link">Classement</a>
							<a href="felix.html" class="nav-link">F√©lix et moi</a>
							<a href="#" id="logout-btn" class="nav-link logout">D√©connexion</a>
						</nav>


		<main>
			<div id="loading-overlay">
				<h2>Initialisation...</h2>
				<p style="color:var(--text-dim)">R√©cup√©ration des donn√©es</p>
			</div>

			<div class="profile-header">
				<img id="avatar" class="avatar-large" src="">
					<div style="flex-grow:1;">
						<h1 id="username" style="margin:0;">Chargement...</h1>
						<div id="rank" style="color:var(--text-dim);">Rang #--</div>
						<div class="badges-list" id="badges-container"></div>
					</div>
				</div>

			<div class="xp-container">
				<div class="xp-text">
					<span style="color:white; font-weight:bold; letter-spacing: 1px;">
						NIVEAU <span id="stat-level-text">1</span>
					</span>
					<span>
						<span id="current-xp">0</span> / <span id="next-level-xp">100</span> XP
					</span>
				</div>
				<div class="xp-bar-bg">
					<div class="xp-fill" id="xp-fill"></div>
				</div>
			</div>

			<div class="stats-mini-grid">
				<div class="stat-box">
					<div class="stat-title">Niveau</div>
					<div class="stat-num" id="stat-level">1</div>
				</div>
				<div class="stat-box">
					<div class="stat-title">Watchtime</div>
					<div class="stat-num" id="stat-watchtime">-</div>
				</div>
				<div class="stat-box">
					<div class="stat-title">XP Total</div>
					<div class="stat-num" id="stat-xp">0</div>
				</div>
				<div class="stat-box">
					<div class="stat-title">Abonnement</div>
					<div class="stat-num" id="stat-sub">...</div>
				</div>
			</div>

			<div class="id-card">
				<div class="id-title">IDENTIT√â VIEWER (IA)</div>
				<div class="id-grid" id="ai-id-content">
					<p style="color:var(--text-dim); font-style:italic;">F√©lix analyse vos interactions...</p>
				</div>
			</div>

			<div class="main-grid">
				<div class="card-panel">
					<h3 style="color:white; margin-bottom:15px; border-bottom:1px solid var(--border); padding-bottom:10px;">üìú Historique XP</h3>
					<ul class="history-list" id="xp-history-list"></ul>
				</div>

				<div class="card-panel" id="poll-container" style="display:none;">
					<h3 style="color:var(--accent); margin-bottom:10px;">üìä Sondage en cours</h3>
					<p id="poll-question" style="font-weight:bold; color:white; margin-bottom:1.5rem; font-size:1.1rem;"></p>
					<div id="poll-options"></div>
				</div>
			</div>
		</main>

		<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
		<script src="app.js"></script>

		<script>
			const CLIENT_ID_VERCEL = "kgyfzs0k3wk8enx7p3pd6299ro4izv";
			const BROADCASTER_NAME = "masthom_";

			let db;
			let userVote = null;
			let currentPollData = null;

			// --- UTILITAIRES ---
			function sanitize(k) {
			if (!k) return "";
			return k.toString().replace(/\//g, "-").replace(/\./g, "_").replace(/[\$#\[\]]/g, "");
			}

			function formatDate(timestamp) {
			if (!timestamp) return "Date inconnue";
			const d = new Date(timestamp);
			return d.toLocaleDateString('fr-FR') + " " + d.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
			}

			// --- LOGIQUE PRINCIPALE ---
			document.addEventListener("DOMContentLoaded", async () => {
			const token = checkAuth();
			if (!token) return;

			try {
			const headers = { 'Authorization': `Bearer ${token}`, 'Client-Id': CLIENT_ID_VERCEL };

			// 1. Infos Twitch
			const userResp = await fetch('https://api.twitch.tv/helix/users', { headers });
			const userData = await userResp.json();
			const user = userData.data[0];
			const userKey = user.login.toLowerCase();
			localStorage.setItem('twitch_username', userKey);

			document.getElementById("username").textContent = user.display_name;
			document.getElementById("avatar").src = user.profile_image_url;

			// 2. Initialisation DB
			db = firebase.database();

			// 3. √âcoute Vote Persistant
			db.ref('user_persistent_votes/' + userKey).on('value', snap => {
			const data = snap.val();
			if (data) {
			userVote = data.option;
			window.refreshPollUI();
			}
			});

			// 4. √âcoute Sondage Actif
			db.ref('current_poll').on('value', snap => {
			currentPollData = snap.val();
			window.refreshPollUI();
			document.getElementById("loading-overlay").style.display = "none";
			});

			// --- RENDU SONDAGE ---
			window.refreshPollUI = function() {
			const poll = currentPollData;
			const container = document.getElementById('poll-container');
			const optionsDiv = document.getElementById('poll-options');

			if (!poll || !poll.active) {
			container.style.display = 'none';
			return;
			}

			container.style.display = 'block';
			document.getElementById('poll-question').textContent = poll.question;
			optionsDiv.innerHTML = "";

			poll.options.forEach(option => {
			const safeKey = sanitize(option);
			const percent = (poll.stats && poll.stats[safeKey]) ? poll.stats[safeKey] : 0;
			const isMyVote = (userVote === option);

			const wrapper = document.createElement('div');
			wrapper.className = "poll-option-container";
			wrapper.innerHTML = `
			<div class="poll-option-bg" style="border-color: ${isMyVote ? 'var(--accent)' : 'var(--border)'}">
				<div class="poll-option-fill" style="width: ${percent}%; opacity: ${isMyVote ? '0.4' : '0.15'}"></div>
				<div class="poll-option-label">
					<span>${isMyVote ? '‚úÖ ' : ''}${option}</span>
					<span style="font-family: monospace;">${percent}%</span>
				</div>
			</div>`;

			wrapper.onclick = () => window.castVote(poll.id, option);
			optionsDiv.appendChild(wrapper);
			});
			};

			// --- XP & WATCHTIME ---
			db.ref('viewer_data/xp_data/' + userKey).on('value', snap => {
			const data = snap.val();
			let xp = (data && typeof data === 'object') ? (data.xp || 0) : (data || 0);
			const level = calculateLevel(xp);

			document.getElementById("stat-level").textContent = level;
			document.getElementById("stat-level-text").textContent = level;
			document.getElementById("stat-xp").textContent = xp.toLocaleString();

			const wt = data?.watchtime_seconds || 0;
			document.getElementById("stat-watchtime").textContent = `${Math.floor(wt/3600)}h ${Math.floor((wt%3600)/60)}m`;

			const nextXp = Math.floor(100 * Math.pow(level, 2.2));
			const currXp = Math.floor(100 * Math.pow(level - 1, 2.2));
			const prog = ((xp - currXp) / (nextXp - currXp)) * 100;

			document.getElementById("xp-fill").style.width = Math.min(100, Math.max(0, prog)) + "%";
			document.getElementById("current-xp").textContent = xp.toLocaleString();
			document.getElementById("next-level-xp").textContent = nextXp.toLocaleString();
			});

			// --- HISTORIQUE ---
			db.ref('viewer_data/history/' + userKey).limitToLast(15).on('value', snap => {
			const list = document.getElementById("xp-history-list");
			if (snap.val()) {
			list.innerHTML = "";
			Object.values(snap.val()).reverse().forEach(h => {
			list.innerHTML += `
			<li class="history-item">
				<div>
					<div style="color:white;">${h.reason}</div>
					<div style="font-size:0.75rem; color:var(--text-dim);">${formatDate(h.timestamp)}</div>
				</div>
				<div class="history-val">+${h.amount} XP</div>
			</li>`;
			});
			}
			});

			// --- RANG ---
			db.ref('viewer_data/xp_data').once('value').then(snap => {
			const all = snap.val() || {};
			const sorted = Object.entries(all)
			.map(([k, v]) => ({ k, xp: (v && typeof v === 'object' ? v.xp : v) || 0 }))
			.sort((a, b) => b.xp - a.xp);
			const myRank = sorted.findIndex(u => u.k === userKey) + 1;
			document.getElementById("rank").textContent = myRank > 0 ? `Rang #${myRank}` : "Non class√©";
			});

			// --- TWITCH BADGES ---
			const chResp = await fetch(`https://api.twitch.tv/helix/users?login=${BROADCASTER_NAME}`, { headers });
			const chData = await chResp.json();
			const bId = chData.data[0].id;

			fetch(`https://api.twitch.tv/helix/subscriptions/user?broadcaster_id=${bId}&user_id=${user.id}`, { headers })
			.then(r => r.status === 200 ? r.json() : null)
			.then(d => {
			const bDiv = document.getElementById("badges-container");
			if (d?.data?.length > 0) {
			bDiv.innerHTML += `<div class="badge badge-sub">Abonn√©</div>`;
			document.getElementById("stat-sub").textContent = "Oui";
			} else {
			document.getElementById("stat-sub").textContent = "Non";
			}
			});

			} catch (e) { console.error("‚ùå Erreur Profil:", e); }
			});

			// --- ACTION DE VOTE ---
			window.castVote = async function(pId, opt) {
			const name = localStorage.getItem('twitch_username');
			if (!name || !db) return;

			// Mise √† jour optimiste (visuelle imm√©diate)
			userVote = opt;
			window.refreshPollUI();

			try {
			// Double √©criture pour la file d'attente (Pi) et la persistance (UI)
			await db.ref('poll_incoming_votes/' + name).set({
			poll_id: pId, option: opt, username: name,
			timestamp: firebase.database.ServerValue.TIMESTAMP
			});
			await db.ref('user_persistent_votes/' + name).set({ poll_id: pId, option: opt });
			} catch (e) { console.error("‚ùå Erreur Vote:", e); }
			};
		</script>
	</body>
</html>